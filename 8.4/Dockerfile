FROM serversideup/php:8.4-fpm-nginx-alpine

COPY --chmod=755 common/ /

# PHP limits
ENV PHP_MEMORY_LIMIT=256M
ENV PHP_POST_MAX_SIZE=100M
ENV PHP_UPLOAD_MAX_FILE_SIZE=${PHP_POST_MAX_SIZE}

# OPcache settings
ENV PHP_OPCACHE_ENABLE=1
ENV PHP_OPCACHE_INTERNED_STRINGS_BUFFER=8
ENV PHP_OPCACHE_MEMORY_CONSUMPTION=128
ENV PHP_OPCACHE_REVALIDATE_FREQ=2

# PHP-FPM settings
ENV PHP_FPM_PM_CONTROL=ondemand
ENV PHP_FPM_PM_MAX_CHILDREN=20
ENV PHP_FPM_PM_START_SERVERS=2
ENV PHP_FPM_PM_MIN_SPARE_SERVERS=1
ENV PHP_FPM_PM_MAX_SPARE_SERVERS=3

# Laravel settings
ENV AUTORUN_ENABLED=true
ENV AUTORUN_LARAVEL_MIGRATION=true
ENV AUTORUN_LARAVEL_STORAGE_LINK=true
ENV AUTORUN_LARAVEL_CONFIG_CACHE=true
ENV AUTORUN_LARAVEL_EVENT_CACHE=true
ENV AUTORUN_LARAVEL_ROUTE_CACHE=true
ENV AUTORUN_LARAVEL_VIEW_CACHE=true
ENV AUTORUN_LARAVEL_FILAMENT=true

ENV HEALTHCHECK_PATH=/up

# Composer settings
ENV COMPOSER_ALLOW_SUPERUSER=0
ENV COMPOSER_CACHE_DIR=/dev/null
ENV COMPOSER_FUND=0
ENV COMPOSER_HOME=/tmp
ENV COMPOSER_NO_DEV=1
ENV COMPOSER_NO_INTERACTION=1

# Switch to root so we can do root things
USER root

# Install additional PHP extensions
RUN set -ex; \
    install-php-extensions \
    event \
    excimer \
    exif \
    gd \
    intl;

# Drop back to our unprivileged user
USER www-data

ARG VERSION
ARG REVISION

RUN echo "$VERSION (${REVISION:0:7})" > ${APP_BASE_DIR}/.version

EXPOSE 8080 8443
